<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最大攝氧量檢查資料上傳</title>
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
        crossorigin="anonymous" 
    />
    <style>
        form {
            font-size: 20px !important;
            width: auto;
			
        }
        #chart {
    width: 1000px;
    height: 250px;
}
    </style>
 
</head>
<body>
    <div class="text-center"> 
        <button class="btn btn-outline-primary btn-lg" onclick="calculateMaxOxygen()">計算</button>
        <button class="btn btn-outline-primary btn-lg" id="myButton">查閱上傳資料</button>
    </div>
    <form
        id = "form"
        class = "mx-auto my-5 shadow p-2"
        method = "POST"
    >
    <!-- action= will be set by javascript -->
	     <div style="text-align: right;">
		 <button type="submit" class="btn btn-outline-danger btn-lg">上傳資料</button>
		 </div>
         <p>今天日期: <span id="today_date"></span></p>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="name">姓名:</label>
            <input
                type="text"
                id="name"
                name="name"
                list="name"
            />
            <datalist id="name">
                <!-- javascript will add options here -->
            </datalist>
        </div class="mb-3 text-left">       
            <label  class="mb-3 text-left" for="gender">性別:</label>
            <select id="gender" name="gender">
              <option value="male">男</option>  
              <option value="female">女</option>
            </select>
            <datalist id="gender">
                <!-- javascript will add options here -->
            </datalist>
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="birthdate">生日:</label>
            <input
                type="date"
                id="birthdate"
                name="birthdate"
                list="birthdate"
            />
            <datalist id="birthdate">
                <!-- javascript will add options here -->                
            </datalist>
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="medical_record">病歷號碼:</label>
            <input
                type="text"
                class="medical_record"
                id="medical_record"
                name="medical_record"
            />
            <datalist id="medical_record">
                <!-- javascript will add options here -->                
            </datalist>
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="stage1_hr">階段 1 心率:</label>
            <input
                type="number"
                class="stage_hr"
                id="stage1_hr"
                name="stage1_hr"
            />
            <datalist id="stage1_hr">
                <!-- javascript will add options here -->                
            </datalist>
        </div>

        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="stage2_hr">階段 2 心率:</label>
            <input
                type="number"
                class="stage_hr"
                id="stage2_hr"
                name="stage2_hr"
            />
            <datalist id="stage2_hr">
                <!-- javascript will add options here -->                
            </datalist>
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="stage3_hr">階段 3 心率:</label>
            <input
                type="number"
                class="stage_hr"
                id="stage3_hr"
                name="stage3_hr"
            />
            <datalist id="stage3_hr">
                <!-- javascript will add options here -->                
            </datalist>        
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="stage4_hr">階段 4 心率:</label>
            <input
                type="number"
                class="stage_hr"
                id="stage4_hr"
                name="stage4_hr"
            />
            <datalist id="stage4_hr">
                <!-- javascript will add options here -->                
            </datalist>        
        </div>
        <div class="mb-3 text-left">
            <label class="mb-3 text-left" for="stage5_hr">階段 5 心率:</label>
            <input
                type="number"
                class="stage_hr"
                id="stage5_hr"
                name="stage5_hr"
            />
            <datalist id="stage5_hr">
                <!-- javascript will add options here -->                
            </datalist>
        </div> 
        <div class="mb-3 text-left" style="display: none;">
            <label class="mb-3 text-left" for="maxhrvalue">最大心率:</label>
            <input
                type="number"
                class="maxhrvalue"
                id="maxhrvalue"
                name="maxhrvalue"
                readonly
            />
            <datalist id="maxhrvalue">
                <!-- javascript will add options here -->                
            </datalist>
        </div>
        <div class="mb-3 text-left" style="display: none;">
            <label class="mb-3 text-left" for="maxhrvalue08">0.8倍最大心率:</label>
            <input
                type="number"
                class="maxhrvalue08"
                id="maxhrvalue08"
                name="maxhrvalue08"
                readonly
            />
            
            <datalist id="maxhrvalue08">
                <!-- javascript will add options here -->                
            </datalist>
        </div>
        <div class="mb-3 text-left" style="display: none;">
            <label class="mb-3 text-left" for="oxygenmax">最大攝氧量:</label>
            <input
                type="number"
                class="oxygenmax"
                id="oxygenmax"
                name="oxygenmax"
                readonly
            />
            <datalist id="oxygenmax">
                <!-- javascript will add options here -->                
            </datalist>
        </div>    
            
        
        <h2 class="mb-3 text-left" style="font-size: 23px; color: blue; font-weight: bold;">最大心率：</h2>
        <p id="max_hr"></p>       
        <h2 class="mb-3 text-left" style="font-size: 23px; color: blue; font-weight: bold;"> 0.8倍最大心率：</h2>
        <p id="max_oxygen_08"></p>
    
        <h2 class="mb-3 text-left" style="font-size: 23px; color: blue; font-weight: bold;"> 最大攝氧量：</h2>
        <p id="max_oxygen"></p>
        <div id="message" style="display: none;"></div>
    
        <h2 class="mb-3 text-left" style="font-size: 23px; color: blue; font-weight: bold;"> 圖表：</h2>
        <div id="chart"></div>

        
    </form>

    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        document.getElementById("myButton").addEventListener("click", function() {
            // 在這裡指定要前往的網頁URL
        window.location.href = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUfrItc7LBRVxzs9XjPldJZ--7so-fXduh-ijsX_0yn7tC7PQKjMZBDJoJXDdw4Znwbi_U4icZhE7Q/pubhtml?gid=737260878&single=true"; 
        });
        const url = "https://script.google.com/macros/s/AKfycbz3YhqMNZ9KpEKXElYzD_n8U_yf3un504FGDscFhfE50LUcrlJfiBqGuBQkhTP4zTCF/exec" // enter your public ('access' - 'anyone') deployment URL (NOT test deployment!)
        document.getElementById('form').action = url;
        var plot;

function calculateMaxOxygen() {
    if (plot) {
        Plotly.purge('chart');
    }

    var stage_hr_values = [];
    var stage_hr_elements = document.getElementsByClassName('stage_hr');
    for (var i = 0; i < stage_hr_elements.length; i++) {
        var value = parseInt(stage_hr_elements[i].value);
        if (!isNaN(value)) {
            stage_hr_values.push(value);
        }
    }

    var age = calculateAge();

    var max_hr = 220 - age;
    window.max_hr = max_hr;
    var maxhrvalueInput = document.getElementById("maxhrvalue");
    var maxhrvalue08valueInput = document.getElementById("maxhrvalue08");
    var oxygenmaxvalueInput = document.getElementById("oxygenmax");
    maxhrvalueInput.value = max_hr;
    var max_hr_output = document.getElementById('max_hr');
    var max_oxygen_output = document.getElementById('max_oxygen');
    var max_oxygen_08_output = document.getElementById('max_oxygen_08');
    max_hr_output.innerHTML = max_hr;
    max_oxygen_output.innerHTML = calculateMaxOxygenValue(max_hr).toFixed(2);
    max_oxygen_08_output.innerHTML = (0.8 * max_hr).toFixed(2);
    maxhrvalue08valueInput.value = (0.8 * max_hr).toFixed(2);
    

    if (stage_hr_values.length < 3) {
        max_oxygen_output.innerHTML = 'Fail';
        return;
    }

    // Perform linear regression
    var x = stage_hr_values;
    var y = [14, 20, 26, 32, 38].slice(0, x.length);

    var sumX = 0;
    var sumY = 0;
    var sumXY = 0;
    var sumXX = 0;

    for (var i = 0; i < x.length; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumXX += x[i] * x[i];
    }

    var n = x.length;
    var slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    var intercept = (sumY - slope * sumX) / n;

    var max_oxygen = slope * max_hr + intercept;

    // Display the result
    max_oxygen_output.innerHTML = max_oxygen.toFixed(2);
    oxygenmaxvalueInput.value = max_oxygen.toFixed(2);;

    // Plot the graph
    var trace = {
        x: x,
        y: y,
        mode: 'markers',
        type: 'scatter',
        name: 'Data Points'
    };

    var regressionLine = {
        x: [Math.min(...x), max_hr],
        y: [intercept + slope * Math.min(...x), intercept + slope * max_hr],
        mode: 'lines',
        type: 'scatter',
        name: 'Regression Line'
    };

    var maxOxygenPoint = {
        x: [max_hr],
        y: [max_oxygen],
        mode: 'markers',
        type: 'scatter',
        name: 'Max Oxygen',
        marker: {
            color: 'red',
            size: 10
        }
    };

    var layout = {
        title: 'Max Oxygen and Heart Rate',
        xaxis: { title: 'Heart Rate' },
        yaxis: { title: 'Max Oxygen' }
    };

    var plotData = [trace, regressionLine, maxOxygenPoint];

    plot = Plotly.newPlot('chart', plotData, layout);
}

function calculateAge() {
    var birthdate = document.getElementById('birthdate').value;
    var today = new Date();
    var birthdateObj = new Date(birthdate);
    var age = today.getFullYear() - birthdateObj.getFullYear();
    var monthDiff = today.getMonth() - birthdateObj.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdateObj.getDate())) {
        age--;
    }
    return age;
}

function calculateMaxOxygenValue(max_hr) {
    return 15.3 * max_hr / 1000;
}

window.onload = function() {
    var today = new Date();
    var todayDateElement = document.getElementById('today_date');
    todayDateElement.innerHTML = today.toLocaleDateString();
}

        // fetching the data from each column in the sheet
        // then populating the respective datalist
        fetch(`${url}?header=name`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("name", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));

        fetch(`${url}?header=gender`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("gender", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        
        fetch(`${url}?header=birthdate`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("birthdate", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=medical_record`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("medical_record", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));    
        fetch(`${url}?header=stage1_hr`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("stage1_hr", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=stage2_hr`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("stage2_hr", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=stage3_hr`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("stage3_hr", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=stage4_hr`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("stage4_hr", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=stage5_hr`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("stage5_hr", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=maxhrvalue`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("maxhrvalue", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));
        fetch(`${url}?header=maxhrvalue08`)
            .then((response) => response.json())
            .then(({ data }) => {
                console.log(data);
                populateDatalists("maxhrvalue08", data)
            })
            .catch((error) => console.error('!!!!!!!!', error));                                  
        // function to add options to datalists
        const populateDatalists = (id, arr) => {
            let result = '';
            for (const item of arr) {
                result += `<option value="${item}">`;
            }
            document.getElementById(id).innerHTML = result;
        }
    </script>
</body>
</html>